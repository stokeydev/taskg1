function addCountryListControl(){L.Control.CountryList=L.Control.extend({onAdd:function(){return $select=$('<select id="countryList" class="form-control leaflet-control leaflet-bar" onchange="validateCountry(this.value)"></select>'),$select.append('<option value="" disabled selected hidden>Select a country</option>'),$select.get(0)}}),L.control.countryList=function(t){return new L.Control.CountryList(t)},L.control.countryList({position:"topleft"}).addTo(map),L.DomEvent.disableClickPropagation($("#countryList").get(0))}function checkURLHash(){location.hash?(hash=decodeURI(location.hash.substring(1)),validateCountry(hash)):map.locate()}function convertTime(t,e){const o=new Date(1e3*(t+e));let n=o.getUTCHours();n=n<10?`0${n}`:n;let a=o.getUTCMinutes();return a=a<10?`0${a}`:a,`${n}:${a}`}function displayBorders(){const t=countryData.borders.geometry;let e=[];"MultiPolygon"===t.type?t.coordinates.forEach(t=>{let o=[];t[0].forEach(t=>{const e=t[1],n=t[0];o.push([e,n])}),e.push(o)}):t.coordinates[0].forEach(t=>{const o=t[0],n=t[1];e.push([n,o])}),map.fitBounds(e),window.borders=L.polygon(e,{bubblingMouseEvents:!1}).addTo(map),L.DomEvent.disableClickPropagation($(window.borders).get(0))}function displayCountryInfo(){const t=countryData.opencage,e=countryData.rest;let o={};callcode=t.annotations.callingcode||null,o.callingCode=callcode?`+${callcode}`:null,o.capital=e.capital||null,o.continent=t.components.continent||null,o.countryCode=t.components.country_code||null,o.demonym=e.demonym||null;let n=e.area||null;n&&(n=formatNumber(n),o.landArea=n);let a=[];e.languages.forEach(t=>a.push(t.name)),a.length>1?(o.languages=a.join(", "),o.language=null):(o.language=a[0],o.languages=null);let r=e.population||null;r&&(o.population=formatNumber(r)),o.tld=e.topLevelDomain[0]||null;const i=t.annotations.timezone.short_name||null;let l=t.annotations.timezone.offset_string||null;l=l?`(${l})`:null,o.tz=`${i} ${l}`,$("#countryName").text(countryName),$("#countryFlag").attr("src",e.flag);for(let t in o)o[t]?($(`#${t}`).html(o[t]),$(`#${t}Row`).show()):$(`#${t}Row`).hide();o.wiki=countryData.wiki||null,$("#wiki").attr("href",o.wiki),displayMainCurrency()}function displayCities(){const t=countryData.cities;let e=[];t.forEach(t=>{const o=L.ExtraMarkers.icon({prefix:"fa",icon:"fa-city",markerColor:t.name===countryData.rest.capital?"red":"yellow"}),n=L.marker([t.coordinates.latitude,t.coordinates.longitude],{icon:o,title:t.name});n.on("click",function(){markerModal({title:t.name,summary:t.snippet,image:t.images?t.images.sizes.thumbnail.url:null,wiki:t.wiki}),t.weather?weather(t.weather):$("#weather").addClass("d-none")}),e.push(n)}),window.markers.addLayers(e).addTo(map)}function displayCovid(){const t=countryData.covid;let e={};lastEntry=t.length-1,recent=t[lastEntry],prevD=t[lastEntry-1],prevW=t[lastEntry-7],prevM=t[lastEntry-30],e.latestDate=recent.date,e.tC=formatNumber(recent.confirmed),e.tD=formatNumber(recent.deaths),e.tR=formatNumber(recent.recovered),e.lC=formatNumber(recent.confirmed-prevD.confirmed),e.lD=formatNumber(recent.deaths-prevD.deaths),e.lR=formatNumber(recent.recovered-prevD.recovered),e.wC=formatNumber(recent.confirmed-prevW.confirmed),e.wD=formatNumber(recent.deaths-prevW.deaths),e.wR=formatNumber(recent.recovered-prevW.recovered),e.mC=formatNumber(recent.confirmed-prevM.confirmed),e.mD=formatNumber(recent.deaths-prevM.deaths),e.mR=formatNumber(recent.recovered-prevM.recovered);for(const t in e)if(Object.hasOwnProperty.call(e,t)){const o=e[t];$(`#${t}`).text(o)}$("#covid-link").removeClass("d-none")}function displayMainCurrency(){const t=countryData.opencage.annotations.currency,e=t.html_entity||t.symbol||null,o=t.iso_code||null,n=t.name||null,a=t.subunit||null;let r=null;e&&a?r=`(${e} / ${a})`:e&&!a?r=`(${e})`:!e&&a&&(r=`(${a})`);const i="EUR"===t.iso_code?"svg\\Europe.svg":countryData.rest.flag;$("#countryCurrencyFlag").attr({src:i,alt:`${countryName} flag`}),$("#countryCurrencyCode").text(o),$("#countryCurrency").html(`${n} ${r}`)}function displayMountains(){let t=[];const e=L.ExtraMarkers.icon({prefix:"fa",icon:"fa-mountain",markerColor:"green"}),o=countryData.mountains;o.forEach(o=>{const n=L.marker([o.coordinates.latitude,o.coordinates.longitude],{icon:e,title:o.name});n.on("click",function(){markerModal({title:o.name,summary:o.snippet,image:o.images?o.images.sizes.thumbnail.url:null,wiki:o.wiki})}),t.push(n)}),window.markers.addLayers(t).addTo(map)}function displayPOIs(){const t=countryData.POIs;let e=[];const o=L.ExtraMarkers.icon({prefix:"fa",icon:"fa-star",markerColor:"blue"});t.forEach(t=>{const n=L.marker([t.coordinates.latitude,t.coordinates.longitude],{icon:o,title:t.name});n.on("click",function(){markerModal({title:t.name,summary:t.snippet,image:t.images?t.images.sizes.thumbnail.url:null,wiki:t.wiki})}),e.push(n)}),window.markers.addLayers(e).addTo(map)}function displayRates(){const t=countryData.opencage.annotations.currency,e=(t.html_entity||t.symbol,t.iso_code||null),o=countryData.rates;for(const t in o.rates){const n=Number(o.rates[t]).toFixed(3),a=o.flags[t];$(`#${t}Flag`).attr({src:a,alt:t+" flag"}),$(`#${t}Code`).text(t),$(`#${t}Rate`).text(n),$(`#${t}Row`).removeClass("d-none"),$("#financeTable").removeClass("d-none"),$("#ratesError").addClass("d-none"),t===e&&$(`#${t}Row`).addClass("d-none")}}function formatNumber(t){return t>1e9?(t/1e9).toPrecision(2)+" billion":t>1e8?Math.round(t/1e6)+" million":t>1e6?(t/1e6).toPrecision(2)+" million":t>1e4?Math.round(t/1e3)+",000":t}function geocode(t,e){$.getJSON("php/api",{get:"geocode",lat:t,lng:e},function(o,n){o.country_code&&getCountry({lat:t,lng:e})})}function getCountry({countryName:t,lat:e,lng:o}){$("#preloader").is(":hidden")&&map.spin(!0),resetMap();let n={get:"country"};t?n.country=t:e&&o&&(n.lat=e,n.lng=o),$.getJSON("php/api",n,function(t,n){console.log(t),e&&o&&(window.countryName=t.opencage.components.country,window.countryCode=t.opencage.components.country_code),window.countryData=t,document.title=`Gazetteer | ${window.countryName}`,location.hash=window.countryName,t.opencage&&t.rest&&(t.borders&&displayBorders(),displayCountryInfo(),t.rates?displayRates():($("#financeTable").addClass("d-none"),$("#ratesError").removeClass("d-none")),t.mountains&&displayMountains(),t.cities&&displayCities(),t.POIs&&displayPOIs(),t.covid?displayCovid():$("#covid-link").addClass("d-none"),window.infoButton.enable())}).then(function(){$("#preloader").fadeOut(),map.spin(!1)})}function getCountryList(){$.getJSON("php/api",{get:"countryList"},function(t,e){t.forEach(t=>{const e=t[0].replace(/ /g,"-");$("#countryList").append(`<option id="${e}" value="${t[0]}" data="${t[1]}">${t[0]}</option>`)})}).then(checkURLHash)}function init(){map.on("click",onMapClick),map.on("locationfound",onLocationFound),map.on("locationerror",onLocationError),L.control.attribution({prefix:'<a href="https://www.leafletjs.com" target="_blank">Leaflet</a>'}).addTo(map);const t=L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{attribution:"Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community"}).addTo(map),e=L.tileLayer("https://map1.vis.earthdata.nasa.gov/wmts-webmerc/VIIRS_CityLights_2012/default/{time}/{tilematrixset}{maxZoom}/{z}/{y}/{x}.{format}",{attribution:'Imagery provided by services from the Global Imagery Browse Services (GIBS), operated by the NASA/GSFC/Earth Science Data and Information System (<a href="https://earthdata.nasa.gov" target="_blank">ESDIS</a>) with funding provided by NASA/HQ.',bounds:[[-85.0511287776,-179.999999975],[85.0511287776,179.999999975]],minZoom:1,maxZoom:8,format:"jpg",time:"",tilematrixset:"GoogleMapsCompatible_Level"}),o=L.tileLayer("https://{s}.tile.jawg.io/jawg-streets/{z}/{x}/{y}{r}.png?access-token=Kyyk5x2h2cziidv4NudH48i2lgxN5j1e3lo5CtRHb8th7m5mbfxeq7qB71thO2ZE",{attribution:'<a href="http://jawg.io" title="Tiles Courtesy of Jawg Maps" target="_blank">&copy; <b>Jawg</b>Maps</a> &copy; <a href="https://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a> contributors',minZoom:0,maxZoom:22,subdomains:"abcd",accessToken:"Kyyk5x2h2cziidv4NudH48i2lgxN5j1e3lo5CtRHb8th7m5mbfxeq7qB71thO2ZE"}),n=L.tileLayer("https://{s}.tile.jawg.io/jawg-dark/{z}/{x}/{y}{r}.png?access-token=Kyyk5x2h2cziidv4NudH48i2lgxN5j1e3lo5CtRHb8th7m5mbfxeq7qB71thO2ZE",{attribution:'<a href="http://jawg.io" title="Tiles Courtesy of Jawg Maps" target="_blank">&copy; <b>Jawg</b>Maps</a> &copy; <a href="https://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a> contributors',minZoom:0,maxZoom:22,subdomains:"abcd",accessToken:"Kyyk5x2h2cziidv4NudH48i2lgxN5j1e3lo5CtRHb8th7m5mbfxeq7qB71thO2ZE"}),a={Streets:o,Dark:n,Satellite:t,Night:e};map.fitWorld(),addCountryListControl(),getCountryList(),L.control.zoom({position:"topright"}).addTo(map),L.easyButton("fa-location-arrow",function(){map.locate()},{position:"topright"}).addTo(map),L.control.layers(a).addTo(map),window.infoButton=L.easyButton("fa-info",function(){$("#countryModal").modal("toggle")},{position:"topleft"}).addTo(map).disable()}function markerModal({title:t,summary:e,image:o,wiki:n}){if($("#markerTitle").text(t),$("#markerSummary").html(e),t===countryData.rest.capital?$("#markerCapital").removeClass("d-none"):$("#markerCapital").addClass("d-none"),o){const e=o.replace("http","https");$("#markerImg").attr({src:e,alt:t}).removeClass("d-none").addClass("d-block")}else $("#markerImg").addClass("d-none").removeClass("d-block");n?($("#markerLink").attr("href",n),$("#markerLink").removeClass("d-none")):$("#markerLink").addClass("d-none"),$("#weather").addClass("d-none"),$("#markerModal").modal("toggle")}function onLocationError(t){alert(t.message),$("#preloader").fadeOut()}function onLocationFound(t){const e=t.latlng.lat,o=t.latlng.lng;getCountry({lat:e,lng:o})}function onMapClick(t){const e=t.latlng.lat%90,o=t.latlng.lng>180?t.latlng.lng-360:t.latlng.lng;geocode(e,o)}function resetMap(){window.borders&&map.removeLayer(borders),window.markers.clearLayers(),window.infoButton&&window.infoButton.disable()}function validateCountry(t){const e=t.replace(/ /g,"-");$(`#${e}`).length?(window.countryName=t,window.countryCode=$(`#${e}`).attr("data"),getCountry({countryName:countryName})):alert("Not a valid country")}function weather(t){$("#summaryIcon").attr("class",`wi wi-owm-${t.weather[0].id}`),$("#summaryText").text(t.weather[0].description);const e=Math.round(t.main.temp),o=Math.round(t.main.feels_like);$("#currentTemp").text(e),e!==o?($("#feelsLike").text(o),$("#feels").removeClass("d-none")):$("#feels").addClass("d-none"),$("#maxTemp").text(Math.round(t.main.temp_max)),$("#minTemp").text(Math.round(t.main.temp_min)),$("#windSpeed").text(Math.round(t.wind.speed)),$("#windIcon").attr("class",`wi wi-wind from-${t.wind.deg}-deg`),$("#windDir").text(t.wind.deg),$("#humidity").text(t.main.humidity),$("#pressure").text(t.main.pressure),$("#sunrise").text(convertTime(t.sys.sunrise,t.timezone)),$("#sunset").text(convertTime(t.sys.sunset,t.timezone)),$("#weather").removeClass("d-none")}window.map=L.map("map",{attributionControl:!1,minZoom:2,maxBounds:[[-180,-180],[180,180]],zoomControl:!1}),window.markers=L.markerClusterGroup({showCoverageOnHover:!1}),window.countryData=null,window.countryName=null,window.countryCode=null,window.infoButton=null,$(function(){init()});